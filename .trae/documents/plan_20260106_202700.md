# Update Detection Module Enhancement Plan

## 1. Analysis of Current Implementation
The update detection is currently implemented in `MainWindow.xaml.cs` around line 850. It creates an `UpdateChecker` instance and calls `CheckForUpdate()` in a background task. If an update is available, it shows a message box; if it fails, it displays an error message.

## 2. Implementation Plan

### 2.1 Create Update Detection Dialog Window
- **File**: `UpdateDetectionWindow.xaml` and `UpdateDetectionWindow.xaml.cs`
- **Purpose**: Dedicated window for update detection with visual feedback and skip button
- **UI Elements**:
  - Progress indicator
  - "Checking for updates..." message
  - Prominent "Skip Detection" button
  - Timeout message with retry option

### 2.2 Enhance UpdateChecker Class
- **File**: `BerryAIGen.Common/UpdateChecker.cs`
- **Changes**:
  - Add timeout support via CancellationToken
  - Enhance error handling
  - Add detailed logging
  - Support cancellation from UI

### 2.3 Implement Skip Detection Functionality
- **In UpdateDetectionWindow.xaml.cs**:
  - Add click handler for Skip button
  - Implement cancellation of ongoing detection
  - Log user action
  - Navigate to main interface

### 2.4 Add 3000ms Timeout Mechanism
- **In UpdateChecker.cs**:
  - Add timeout parameter to CheckForUpdate method
  - Use CancellationTokenSource with timeout
  - Handle OperationCanceledException for timeouts
- **In UpdateDetectionWindow.xaml.cs**:
  - Display timeout message
  - Provide retry option

### 2.5 Fix Abnormal Exit Issues
- **Add comprehensive error handling**:
  - Wrap all network calls in try-catch blocks
  - Handle specific exceptions (Timeout, Network, JSON parsing, etc.)
  - Ensure no unhandled exceptions propagate
  - Log detailed error information

### 2.6 Multi-language Support
- **Add localization keys** in language JSON files:
  - Update detection messages
  - Button texts
  - Error messages
  - Timeout messages
- **Use existing localization system** (`GetLocalizedText()` method)

### 2.7 Update Documentation
- **Update dev-log** with timestamped entry
- **Update user guides** with new functionality
- **Update API documentation** for modified methods

## 3. Technical Implementation Details

### 3.1 Cancellation Mechanism
```csharp
// In UpdateChecker.cs
public async Task<bool> CheckForUpdate(string? path = null, int timeout = 3000)
{
    using var cts = new CancellationTokenSource(timeout);
    // Use cts.Token in network calls
}

// In UpdateDetectionWindow.xaml.cs
private async void SkipButton_Click(object sender, RoutedEventArgs e)
{
    _cts.Cancel();
    Logger.Log("User skipped update detection");
    NavigateToMainInterface();
}
```

### 3.2 Error Handling
```csharp
try
{
    var hasUpdate = await checker.CheckForUpdate(timeout: 3000);
    // Handle update available
}
catch (OperationCanceledException)
{
    // Handle timeout
}
catch (HttpRequestException ex)
{
    // Handle network errors
}
catch (Exception ex)
{
    // Handle all other errors
    Logger.LogError($"Update detection failed: {ex.Message}", ex);
}
```

### 3.3 Multi-language Implementation
```csharp
// In UpdateDetectionWindow.xaml.cs
SkipButton.Content = GetLocalizedText("Update.SkipDetection");
ProgressText.Text = GetLocalizedText("Update.CheckingForUpdates");
```

## 4. Files to Modify
1. `BerryAIGen.Common/UpdateChecker.cs` - Enhance update checker functionality
2. `BerryAIGen.Toolkit/UpdateDetectionWindow.xaml` - New UI window
3. `BerryAIGen.Toolkit/UpdateDetectionWindow.xaml.cs` - Window logic
4. `BerryAIGen.Toolkit/MainWindow.xaml.cs` - Integrate new window
5. Language JSON files - Add new translation keys
6. `document/develop/Dev-Log/2026-01-07Txxxxxx.md` - Update dev-log

## 5. Testing Plan
- Test normal update detection flow
- Test skip button functionality
- Test timeout scenario
- Test network failure scenario
- Test all UI elements in different languages
- Verify error logging works correctly

## 6. Expected Outcomes
- Enhanced update detection with user-friendly interface
- Skip detection option with logging
- 3000ms timeout control with retry option
- Comprehensive error handling preventing abnormal exits
- Full multi-language support
- Updated documentation